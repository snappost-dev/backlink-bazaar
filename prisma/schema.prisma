// ============================================
// BACKLINK BAZAAR - HEAVY ENGINEERING SCHEMA
// ============================================
// Based on: TECHNICAL_ARCH.md & PROJECT_BLUEPRINT.md
// Snappost Backend Protocols (Gary)

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  // extensions = [vector] // Geçici olarak devre dışı - vector extension yüklü değil
}

// ============================================
// CORE ENTITIES
// ============================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  role      String // PUBLISHER, AGENCY, BUYER, ADMIN
  credits   Int      @default(100) // Agency kredi sistemi
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  sitesAsPublisher     Site[]
  ordersAsBuyer        Order[]
  scoutingHistory      ScoutingHistory[]
  agencyTransactions   AgencyTransaction[]

  @@map("users")
}

model Site {
  id          String    @id @default(uuid())
  domain      String    @unique
  status      String // verified, pending, rejected
  category    String
  basePrice   Float
  finalPrice  Float
  metrics     Json // { da, dr, spam }
  traffic     Json // { monthly, organic, referral }
  verifiedAt  DateTime?
  publisherId String? // FK to User (publisher)

  // Data Entry Gates
  origin             String  @default("PUBLISHER_OWNED") // PUBLISHER_OWNED, AGENCY_PORTFOLIO
  verificationStatus String  @default("PENDING") // PENDING, VERIFIED, UNVERIFIED, REJECTED
  isPrivate          Boolean @default(false) // Agency private portfolio flag

  // SEO Data (DataForSEO) - Raw-Analysis-Push Mimarisi
  rawSeoData    Json?     // Ana Kasa: API'den gelen HAM veri (tasks dizisi + local_audit)
  snappostScore Int?      @default(0) // Hızlı okuma: Global Skor (0-100)
  trafficData   Json?     // Hızlı okuma: İşlenmiş trafik verileri
  lastSeoCheck  DateTime? // Son SEO kontrolü zamanı

  // 10 Boyutlu Alt Skorlar (Hybrid SEO Engine v2.0)
  s_tech        Int?      // Technical Score (CF Worker)
  s_sem         Int?      // Semantic Score (DFS + CF)
  s_link        Int?      // Link Equity (DFS)
  s_schema      Int?      // Schema Health (CF)
  s_mon         Int?      // Monetization (DFS)
  s_eeat        Int?      // Trust Rank (E-EAT) (DFS)
  s_fresh       Int?      // Freshness (CF + DFS)
  s_viral       Int?      // Viral Potential (CF)
  s_ux          Int?      // UX Flow (CF Browser Rendering)
  s_global      Int?      // Hesaplanan Ağırlıklı Skor

  // Aksiyon Önerileri
  seoFixes      Json?     // Format: [{ code: 'NO_H1', priority: 'HIGH', message: '...' }]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  publisher User?             @relation(fields: [publisherId], references: [id], onDelete: SetNull)
  // dna       SiteDNA? // Geçici olarak devre dışı - vector extension gerekli
  snapshots ScoutingHistory[]
  orders    Order[]

  @@index([publisherId])
  @@index([status])
  @@index([origin])
  @@index([verificationStatus])
  @@map("sites")
}

// ============================================
// TOPICAL DNA ENGINE (Vector Table)
// ============================================
// Stores OpenAI embeddings (1536 dimensions) for topic matching
// Used for cosine similarity calculation between buyer and publisher sites
// Reference: TECHNICAL_ARCH.md §1
// GEÇİCİ OLARAK DEVRE DIŞI: Vector extension veritabanında yüklü değil

// model SiteDNA {
//   id     String @id @default(uuid())
//   siteId String @unique
//   site   Site   @relation(fields: [siteId], references: [id], onDelete: Cascade)
//
//   // Vector embedding (1536 dimensions from OpenAI)
//   // pgvector extension enables vector similarity search
//   vector Unsupported("vector(1536)")?
//
//   // Top 1000 keywords from GSC (last 3 months)
//   // Stored as array of strings for easy querying
//   topKeywords String[]
//
//   // Full keyword data with metrics (JSON for detailed info)
//   keywords Json? // Array of { keyword: string, clicks: number, impressions: number }
//
//   // Metadata
//   createdAt DateTime @default(now())
//   updatedAt DateTime @updatedAt
//
//   @@index([siteId])
//   @@map("site_dna")
// }

// ============================================
// SCOUTING HISTORY & SNAPSHOTS (Time Machine)
// ============================================
// Immutable snapshot of site data at analysis time
// Never UPDATE, always INSERT (Gary Protocol)
// Reference: TECHNICAL_ARCH.md §2

model ScoutingHistory {
  id     String @id @default(uuid())
  siteId String
  site   Site   @relation(fields: [siteId], references: [id], onDelete: Cascade)

  // Agency that performed the analysis
  agencyId String
  agency   User   @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  // Complete snapshot of site data at analysis time (JSON blob)
  // Contains: metrics, traffic, pricing, status, etc.
  snapshotData Json // Renamed from 'snapshot' for clarity

  // Optional: Diff summary (e.g., "Traffic increased 20%")
  diffSummary String?

  createdAt DateTime @default(now())

  @@index([siteId])
  @@index([agencyId])
  @@index([createdAt])
  @@map("scouting_history")
}

// ============================================
// ORDER & THE BRIEFCASE
// ============================================
// Order management with Briefcase (draft/approved workflow)
// Reference: PROJECT_BLUEPRINT.md §5

model Order {
  id     String @id @default(uuid())
  siteId String
  site   Site   @relation(fields: [siteId], references: [id], onDelete: Cascade)

  // Buyer who placed the order
  buyerId String
  buyer   User   @relation(fields: [buyerId], references: [id], onDelete: Cascade)

  // Order status
  status String // pending, approved, in_progress, completed, cancelled

  // Pricing
  price      Float
  finalPrice Float? // Final price after agency markup

  // The Briefcase: Briefing data
  // draftBrief: Buyer's initial input (from BriefingWizard)
  // approvedBrief: Agency's approved/edited version
  draftBrief    Json? // { readyText, rawData, aiInstruction, targetUrl, anchorText, deadline, placement }
  approvedBrief Json? // Same structure, but agency-approved version
  briefStatus   String @default("PENDING") // PENDING, DRAFT, APPROVED, REJECTED

  // Delivery
  deadline      DateTime?
  completedAt   DateTime?
  publishedLink String? // Final published URL

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([siteId])
  @@index([buyerId])
  @@index([status])
  @@index([createdAt])
  @@map("orders")
}

// ============================================
// VALUATION RULES (Price Engine)
// ============================================
// Dynamic pricing coefficients for the valuation engine
// Optional but recommended for flexible pricing

model ValuationRule {
  id String @id @default(uuid())

  // Minimum Domain Authority (DA) threshold
  minDoz Int @default(0)

  // Traffic multiplier (e.g., 1.2 = 20% bonus for high traffic)
  trafficMultiplier Decimal @default(1.0) @db.Decimal(10, 2)

  // Base floor price (minimum price regardless of metrics)
  baseFloor Decimal @default(50.0) @db.Decimal(10, 2)

  // Category-specific multipliers
  categoryMultipliers Json? // { "Technology": 1.1, "Health": 1.3, ... }

  // Active flag
  isActive Boolean @default(true)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([minDoz])
  @@index([isActive])
  @@map("valuation_rules")
}

// ============================================
// AGENCY CREDIT SYSTEM
// ============================================
// Kredi işlemleri için transaction log
// Reference: DataForSEO entegrasyonu

model AgencyTransaction {
  id          String   @id @default(uuid())
  agencyId    String   // FK to User (role='AGENCY')
  agency      User     @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  amount      Int      // Pozitif: kredi ekleme, Negatif: kredi kullanımı
  type        String   // CREDIT_PURCHASE, SEO_ANALYSIS, REFUND, etc.
  description String?  // İşlem açıklaması
  createdAt   DateTime @default(now())

  @@index([agencyId])
  @@index([type])
  @@index([createdAt])
  @@map("agency_transactions")
}
